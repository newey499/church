<?php
	/******************************
	  Need to include classes that are passed in $_SESSION
	  before instantiating the session
	  ********************************************/
	require_once("../buildform.php");	

	/******************************
		Start a session. This must be the very first thing done on the page.
	**********************************/
	require_once("../session.php");
	$oSession = new session();

	require_once "../globals.php";
	require_once("../mysql.php");

?>

<html>
<!-- Generated by AceHTML Freeware http://freeware.acehtml.com -->
<!-- Creation date: 02/12/2004 -->
<head>

	<title>Organisations</title>
	
<?php
	include_once("../nocache.php");						// Stop clients from cacheing - hopefully
?>

	<meta name="description" content="">
	<meta name="keywords" content="">
	<meta name="author" content="Chris Newey">
	<meta name="generator" content="AceHTML 5 Freeware">
	<link rel="stylesheet" type="text/css" href="css/all.css" />
	<link rel="stylesheet" type="text/css" href="css/3cols.css" />			
</head>
<body>
<!-- ------------------ HEADER --------------------------------------- -->	



<hr />
<!-- ---------------- END HEADER ------------------------------------- -->

	

<?php

// Returns a form object set up as required
function buildFormObject() {

	// If the object isn't in the session then create the object
	// and stash it in the session. If its an insert or a delete always
	// force a new object
	if	($_GET['opcode'] == VALIDATE_WRITE_REC) {
		// There should already be an object stashed in the session
		$obj = $_SESSION['oOrganisations'];
	}	
	else {			

		$query = "SELECT	id,
											orgname,
								 			contact,									
											adr1,
											adr2,
											adr3,
											town,
											country,
											postcode,
											email,
											mobile,
											phone,
											fax,
											description 
						  FROM organisations "; 
						  
		if ((strcmp(strtoupper($_GET['opcode']), INSERT_REC) == 0)) {
			$query = $query . " LIMIT 0 OFFSET 1";  // This is an insert so only get one row for the meta information
		}
		else {
			$query = $query . " WHERE id = " . $_GET['id'];		
		}
					  

		$pkey = array('id'	=> $_GET['id']);
	
		$obj = new buildForm($_GET['opcode'],$query,$pkey,$flds);
	
		$obj->addField('orgname','Name',$_POST['orgname'],'Required');	
		$obj->addField('contact','Contact',$_POST['contact']);
		$obj->addField('adr1','Address',$_POST['adr1']);
		$obj->addField('adr2','',$_POST['adr2']);
		$obj->addField('adr3','',$_POST['adr3']);
		$obj->addField('town','Town',$_POST['town']);			
		$obj->addField('country','Country',$_POST['country']);	
		$obj->addField('postcode','Postcode',$_POST['postcode']);	
		$obj->addField('email','Email',$_POST['email']);	
		$obj->addField('mobile','Mobile',$_POST['mobile']);
		$obj->addField('phone','Phone',$_POST['phone']);
		$obj->addField('fax','Fax',$_POST['fax']);
		$obj->addField('description','Description',$_POST['description']);		
	
		//$obj->addMessageCol('contact','qwerty');
		//$obj->addMessageCol('town','TOWN');

		//$obj->addErrorMessageCol('mobile','mobile error');
			
		// $obj->submitTarget = "sqlorg.php";
		$args = http_build_query(array('opcode' => VALIDATE_WRITE_REC,
																	 'subcode' => $_GET['opcode']	));
		$obj->submitTarget = "editorgs.php?$args";		
		$obj->pkey = array('id' => $_GET['id']); 		
	
		$obj->addLink("admin.php","Admin");	// Add a link to take us back to the Admin page
		$obj->addLink("../index.php","Home");			// Add a link to take us back to the Home page	
		$obj->addLink("borgs.php","Organisation Entries");	// Add a link to take us back to the Home page		

		// Stash the object in the session	
		$_SESSION['oOrganisations'] = $obj;	
	}
	
	return $obj;
}	

/*********************
 Validate fields to be written to row
 ****************************************/
function validate($opcode) {
	
	$timeObj = new mysqltime;
	$dateObj = new mysqldate;
	$result = true;
	
	// If we are going to delete it we don't care if its valid
	if ($opcode == DELETE_REC) {
		return True;
	}
	
	
	// Organization name may not be blank
	if ((!isset($_POST['orgname'])) || (!is_string($_POST['orgname'])) || (trim($_POST['orgname']) == "")) {
		$_SESSION['oOrganisations']->addErrorMessageCol('orgname','*');	
		$result = false;	
	}
	else {
		$_SESSION['oOrganisations']->delErrorMessageCol('orgname');	
	}
	
	
	return $result;
} 
 

	
/********************
 Add/Amend/Delete SQL 
 ***********************/	
function doSQL($mysqli, $opcode) {

	
	switch ($opcode) {
		case INSERT_REC:		
			$stmnt = sprintf("INSERT INTO organisations
												(	orgname,contact,
													adr1,adr2,adr3,town,country,postcode,
													email,mobile,phone,fax,description
												)
												VALUES ('%s','%s',
													'%s','%s','%s','%s','%s','%s',
													'%s','%s','%s','%s','%s')",
												mysql_real_escape_string($_POST['orgname']),												
												mysql_real_escape_string($_POST['contact']),
												mysql_real_escape_string($_POST['adr1']),
												mysql_real_escape_string($_POST['adr2']),													
												mysql_real_escape_string($_POST['adr3']),													
												mysql_real_escape_string($_POST['town']),													
												mysql_real_escape_string($_POST['country']),													
												mysql_real_escape_string($_POST['postcode']),													
												mysql_real_escape_string($_POST['email']),													
												mysql_real_escape_string($_POST['mobile']),													
												mysql_real_escape_string($_POST['phone']),													
												mysql_real_escape_string($_POST['fax']),													
												mysql_real_escape_string($_POST['description'])													
												); 
			$msg = "New record created OK"; 
			break;
			
		case UPDATE_REC:		
			$stmnt = sprintf("UPDATE organisations
												SET 
													orgname = '%s',
													contact = '%s',
													adr1 = '%s',adr2 = '%s',adr3 = '%s',
													town = '%s',country = '%s',postcode = '%s',
													email = '%s',mobile = '%s',phone = '%s',
													fax = '%s',description = '%s'
												WHERE id=%d",
												mysql_real_escape_string($_POST['orgname']),												
												mysql_real_escape_string($_POST['contact']),
												mysql_real_escape_string($_POST['adr1']),
												mysql_real_escape_string($_POST['adr2']),													
												mysql_real_escape_string($_POST['adr3']),													
												mysql_real_escape_string($_POST['town']),													
												mysql_real_escape_string($_POST['country']),													
												mysql_real_escape_string($_POST['postcode']),													
												mysql_real_escape_string($_POST['email']),													
												mysql_real_escape_string($_POST['mobile']),													
												mysql_real_escape_string($_POST['phone']),													
												mysql_real_escape_string($_POST['fax']),													
												mysql_real_escape_string($_POST['description']),		
												$_POST['id']												
												); 
			$msg = "Record updated OK"; 			
			break;
			
		case DELETE_REC:		
			$stmnt = sprintf("DELETE FROM organisations
											 WHERE id=%d",
											 mysql_real_escape_string($_POST['id'])				
											); 
			
			$msg = "Record Deleted OK"; 				
			break;
		default: 			
			break;
	}

	if (mysql_query($stmnt)) {
		print("<p>" . $msg . "</p>\n"); 
		return True;
	}
	else {
		print("<p>" . mysql_error() . "</p>\n");
		return False;
	}

}



/****************************************************************
 ****************************************************************

	Script Entry Point
	==================

 **************************************************************************	
 **************************************************************************/

$obj = buildFormObject();


switch ($_GET['opcode']) {
	case INSERT_REC:		
		print "<h3>Insert a new Organization Entry</h3>\n";
		$obj->exec($opcode);			
		break;
			
	case UPDATE_REC:		
		print "<h3>Update this existing Organization Entry</h3>\n";
		$obj->exec($opcode);			
		break;
			
	case DELETE_REC:		
		print "<h3>Delete this Organization Entry</h3>\n";
		$obj->exec($opcode);			
		break;
			
	case VALIDATE_WRITE_REC:		
		print "<h3>Update Organization Table</h3>\n";
		/* Connect to a MySQL server */ 
		$dbHandle = mysql_connect(MYSQL_SERVER, MYSQL_USERNAME, MYSQL_PASSWORD)
		   or die('Could not connect: ' . mysql_error());

		mysql_select_db(MYSQL_DATABASE)  or die('Could not select database');
		
	
		if (validate($_GET['subcode'])){
			if (doSQL($dbHandle, $_GET['subcode'])) {
				unset($_SESSION['oOrganisations']);
				/**********************
				print "<SCRIPT LANGUAGE=JavaScript>\n";
				print "window.location.href =\"borgs.php\"\n";
				print "</SCRIPT>\n";
				***************************/
				buildMenuItem("admin.php","Admin");	// Add a link to take us back to the Admin page
				buildMenuItem("index.php","Home");			// Add a link to take us back to the Home page	
				buildMenuItem("borgs.php","Organisation Entries");	// Add a link to take us back to the Home page		
			}			
		}
		else {
			print "<h3>Problems with form entries indicated by " . 
						"<SPAN id=\"error\">*</SPAN>" .
						"</h3>";
			$obj->refreshFromPost = True;						
			$obj->exec($opcode);
		}
		break;			
			
		default: 			
			die('Invalid option ['  . $opcode . '] passed to ' . $_SERVER['SCRIPT_NAME']);
			break;
}




	



?>
</P>

<!-- ------------------ FOOTER --------------------------------------- -->
<HR>

</body>
</html>
<!-- ---------------- END FOOTER ------------------------------------- -->
